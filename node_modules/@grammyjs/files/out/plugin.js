"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.hydrateFiles = void 0;
const files_js_1 = require("./files.js");
/**
 * Plugin that hydrates results to `getFile`, and equips the results with
 * methods to download files, or get their URL/path.
 *
 * This plugin is an [API transformer
 * function](https://grammy.dev/advanced/transformers.html) that can be
 * installed on `bot.api`.
 *
 * ```ts
 * bot.api.config.use(hydrateFiles(bot.token))
 * ```
 *
 * Check out [the official plugin
 * documentation](https://grammy.dev/plugins/files.html) on the grammY website.
 *
 * @param token bot token, use `bot.token`
 * @param options optional configuration
 */
function hydrateFiles(token, options) {
    var _a, _b, _c;
    const root = (_a = options === null || options === void 0 ? void 0 : options.apiRoot) !== null && _a !== void 0 ? _a : "https://api.telegram.org";
    const environment = (_b = options === null || options === void 0 ? void 0 : options.environment) !== null && _b !== void 0 ? _b : "prod";
    const buildFileUrl = (_c = options === null || options === void 0 ? void 0 : options.buildFileUrl) !== null && _c !== void 0 ? _c : defaultBuildFileUrl;
    const buildLink = (path) => buildFileUrl(root, token, path, environment);
    const t = async (prev, method, payload, signal) => {
        const res = await prev(method, payload, signal);
        if (res.ok && isFile(res.result)) {
            (0, files_js_1.installFileMethods)(res.result, buildLink);
        }
        return res;
    };
    return t;
}
exports.hydrateFiles = hydrateFiles;
const defaultBuildFileUrl = (root, token, method, env) => {
    const prefix = env === "test" ? "test/" : "";
    return `${root}/file/bot${token}/${prefix}${method}`;
};
function isFile(val) {
    return typeof val === "object" && val !== null && "file_id" in val;
}
